<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>蚊子洞穴冒險 - 遜砲提示版</title>
    <style>
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background-color: #d2b48c;
            font-family: "Microsoft JhengHei", Arial, sans-serif;
        }
        canvas { display: block; }
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; flex-direction: column; justify-content: center;
            align-items: center; background: rgba(0, 0, 0, 0.7); color: white; z-index: 10;
        }
        #info-panel {
            position: absolute; top: 20px; width: 100%;
            display: flex; justify-content: space-around;
            color: white; font-size: 26px; font-weight: bold;
            text-shadow: 2px 2px 5px #000; pointer-events: none; z-index: 5;
        }
        #status-bar {
            position: absolute; top: 60px; width: 100%; text-align: center;
            color: #ffffff; font-size: 20px; font-weight: bold; text-shadow: 1px 1px 4px #000;
            line-height: 1.5;
        }
        #death-msg { font-size: 64px; margin-bottom: 20px; font-weight: 800; }
        button {
            padding: 15px 45px; font-size: 28px; cursor: pointer;
            background-color: #5d4037; color: white; border: 2px solid white; border-radius: 50px;
        }
        button:hover { background-color: #3e2723; transform: scale(1.1); }
        #hint-text {
            margin-top: 25px;
            font-size: 20px;
            color: #ffcccc; /* 微粉色，讓提示顯眼一點 */
            text-shadow: 1px 1px 2px #000;
        }
    </style>
</head>
<body>

<div id="info-panel">
    <div id="score-display">分數: 0</div>
    <div id="speed-display">速度: 1.0x</div>
</div>
<div id="status-bar"></div>

<div id="ui-layer">
    <div id="death-msg"></div>
    <button onclick="resetGame()">再一次</button>
    <div id="hint-text"></div> </div>

<canvas id="gameCanvas"></canvas>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const scoreElement = document.getElementById('score-display');
    const speedElement = document.getElementById('speed-display');
    const statusElement = document.getElementById('status-bar');
    const uiLayer = document.getElementById('ui-layer');
    const deathMsg = document.getElementById('death-msg');
    const hintElement = document.getElementById('hint-text');

    let score = 0;
    let gameActive = true;
    let frameCount = 0;
    let baseScrollSpeed = 5; 
    let speedMultiplier = 1.0;

    // 追蹤本局是否有玩到內容
    let hasEatenSmall = false;
    let hasEatenPoison = false;

    const mosquito = {
        x: 150, y: 0,
        baseSize: 65,
        width: 65, height: 65,
        moveSpeed: 8,
        imgIdx: 0, rotation: 0,
        isSmall: false, smallTimer: 0,
        isBig: false, bigTimer: 0,
        images: []
    };

    const img1 = new Image(); img1.src = '蚊子一.png';
    const img2 = new Image(); img2.src = '蚊子二.png';
    mosquito.images = [img1, img2];

    const smallImg = new Image(); smallImg.src = '縮小.png';
    const poisonImg = new Image(); poisonImg.src = '殺蟲劑.png';

    let obstacles = [];
    let items = [];
    let keys = {};

    function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        mosquito.y = canvas.height / 2;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    window.addEventListener('keydown', e => {
        if (!gameActive) return;
        keys[e.code] = true;
        if (e.code === 'ArrowRight') speedMultiplier += 0.2;
        if (e.code === 'ArrowLeft') speedMultiplier = Math.max(0.2, speedMultiplier - 0.2);
        speedElement.innerText = `速度: ${speedMultiplier.toFixed(1)}x`;
    });
    window.addEventListener('keyup', e => keys[e.code] = false);

    setInterval(() => { if(gameActive) mosquito.imgIdx = 1 - mosquito.imgIdx; }, 120);

    setInterval(() => {
        if (gameActive) {
            score += 10;
            if (score >= 500 && speedMultiplier < 1.4) {
                speedMultiplier = 1.4;
                speedElement.innerText = `速度: ${speedMultiplier.toFixed(1)}x`;
            }
            scoreElement.innerText = `分數: ${score}`;
        }
    }, 1000);

    function spawnObstacles() {
        const minGap = 250; 
        const wallWidth = 110 + Math.random() * 60;
        const safeZoneY = minGap/2 + Math.random() * (canvas.height - minGap);
        const type = Math.random();
        if (type < 0.4) { 
            obstacles.push({ x: canvas.width, y: safeZoneY + minGap/2, width: wallWidth, h: canvas.height });
        } else if (type < 0.8) { 
            obstacles.push({ x: canvas.width, y: 0, width: wallWidth, h: safeZoneY - minGap/2 });
        } else { 
            obstacles.push({ x: canvas.width, y: 0, width: wallWidth, h: safeZoneY - minGap/2 });
            obstacles.push({ x: canvas.width, y: safeZoneY + minGap/2, width: wallWidth, h: canvas.height });
        }
    }

    function isSafe(x, y, size) {
        for (let o of obstacles) {
            if (x < o.x + o.width && x + size > o.x && y < o.y + o.h && y + size > o.y) return false;
        }
        return true;
    }

    function spawnItems() {
        const smallCount = items.filter(it => it.type === 'SMALL').length;
        const poisonCount = items.filter(it => it.type === 'POISON').length;

        if (score >= 150 && !mosquito.isSmall && smallCount < 3) {
            if (Math.random() > 0.995) {
                let ty = 100 + Math.random() * (canvas.height - 200);
                if (isSafe(canvas.width, ty, 50)) {
                    items.push({ x: canvas.width, y: ty, w: 50, h: 50, type: 'SMALL' });
                }
            }
        }
        if (score >= 350 && !mosquito.isBig && poisonCount < 3) {
            if (Math.random() > 0.992) {
                let ty = 100 + Math.random() * (canvas.height - 200);
                if (isSafe(canvas.width, ty, 50)) {
                    items.push({ x: canvas.width, y: ty, w: 50, h: 50, type: 'POISON' });
                }
            }
        }
    }

    function updateSize() {
        let currentScale = 1.0;
        if (mosquito.isSmall) currentScale *= 0.5;
        if (mosquito.isBig) currentScale *= 1.15;
        mosquito.width = mosquito.baseSize * currentScale;
        mosquito.height = mosquito.baseSize * currentScale;
    }

    function update() {
        if (!gameActive) return;

        if (keys['ArrowUp'] && mosquito.y > 0) {
            mosquito.y -= mosquito.moveSpeed;
            mosquito.rotation = -0.25;
        } else if (keys['ArrowDown'] && mosquito.y < canvas.height - mosquito.height) {
            mosquito.y += mosquito.moveSpeed;
            mosquito.rotation = 0.25;
        } else { mosquito.rotation *= 0.9; }

        const currentScrollSpeed = baseScrollSpeed * speedMultiplier;
        let rate = (score >= 500) ? 60 : 80;
        if (frameCount % Math.max(15, Math.floor(rate / speedMultiplier)) === 0) spawnObstacles();
        spawnItems();

        for (let i = items.length - 1; i >= 0; i--) {
            let it = items[i];
            it.x -= currentScrollSpeed;
            if (mosquito.x < it.x + it.w && mosquito.x + mosquito.width > it.x &&
                mosquito.y < it.y + it.h && mosquito.y + mosquito.height > it.y) {
                if (it.type === 'SMALL') {
                    mosquito.isSmall = true; mosquito.smallTimer = 20 * 60;
                    hasEatenSmall = true; // 記錄吃過
                } else {
                    mosquito.isBig = true; mosquito.bigTimer = 10 * 60;
                    hasEatenPoison = true; // 記錄吃過
                    score = Math.max(0, score - 40);
                    scoreElement.innerText = `分數: ${score}`;
                }
                updateSize();
                items.splice(i, 1);
            }
            if (it.x < -100) items.splice(i, 1);
        }

        for (let i = obstacles.length - 1; i >= 0; i--) {
            let o = obstacles[i];
            o.x -= currentScrollSpeed;
            if (mosquito.x + 10 < o.x + o.width && mosquito.x + mosquito.width - 10 > o.x &&
                mosquito.y + 10 < o.y + o.h && mosquito.y + mosquito.height - 10 > o.y) gameOver();
            if (o.x + o.width < -500) obstacles.splice(i, 1);
        }

        let statusText = "";
        if (mosquito.isSmall) {
            mosquito.smallTimer--;
            statusText += `✨ 縮小防護: ${Math.ceil(mosquito.smallTimer/60)}s `;
            if (mosquito.smallTimer <= 0) { mosquito.isSmall = false; updateSize(); }
        }
        if (mosquito.isBig) {
            mosquito.bigTimer--;
            statusText += `☠️ 殺蟲劑中毒(放大): ${Math.ceil(mosquito.bigTimer/60)}s`;
            if (mosquito.bigTimer <= 0) { mosquito.isBig = false; updateSize(); }
        }
        statusElement.innerText = statusText;
        statusElement.style.color = "white";

        frameCount++;
    }

    function draw() {
        ctx.fillStyle = "#d2b48c"; ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "#3e2723"; 
        obstacles.forEach(o => {
            ctx.fillRect(o.x, o.y, o.width, o.h);
            ctx.strokeStyle = "#2b1b17"; ctx.lineWidth = 2; ctx.strokeRect(o.x, o.y, o.width, o.h);
        });
        items.forEach(it => {
            let img = (it.type === 'SMALL') ? smallImg : poisonImg;
            if (img.complete && img.naturalWidth > 0) ctx.drawImage(img, it.x, it.y, it.w, it.h);
            else { ctx.fillStyle = (it.type === 'SMALL') ? "blue" : "red"; ctx.fillRect(it.x, it.y, it.w, it.h); }
        });
        ctx.save();
        ctx.translate(mosquito.x + mosquito.width/2, mosquito.y + mosquito.height/2);
        ctx.rotate(mosquito.rotation);
        const breathe = Math.sin(frameCount * 0.2) * 2;
        const img = mosquito.images[mosquito.imgIdx];
        if (img.complete) ctx.drawImage(img, -mosquito.width/2 - breathe/2, -mosquito.height/2 - breathe/2, mosquito.width + breathe, mosquito.height + breathe);
        ctx.restore();
    }

    function gameLoop() { update(); draw(); if (gameActive) requestAnimationFrame(gameLoop); }

    function gameOver() {
        gameActive = false;
        deathMsg.innerText = "菜就多練";
        
        // 判定是否顯示遜砲提示
        if (score < 500 || !hasEatenSmall || !hasEatenPoison) {
            hintElement.innerText = "溫馨提示:還有東西沒玩到，遜哪";
        } else {
            hintElement.innerText = "";
        }
        
        uiLayer.style.display = 'flex';
    }

    function resetGame() {
        score = 0; speedMultiplier = 1.0; baseScrollSpeed = 5;
        hasEatenSmall = false; hasEatenPoison = false; // 重置本局追蹤
        scoreElement.innerText = `分數: 0`; speedElement.innerText = `速度: 1.0x`;
        obstacles = []; items = []; frameCount = 0; gameActive = true;
        mosquito.isSmall = false; mosquito.isBig = false; updateSize();
        uiLayer.style.display = 'none'; statusElement.innerText = "";
        hintElement.innerText = ""; 
        mosquito.y = canvas.height / 2; gameLoop();
    }
    gameLoop();
</script>
</body>
</html>