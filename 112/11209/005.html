<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>歷史科學射擊遊戲 - 修正版</title>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background-color: #2e7d32; font-family: "Microsoft JhengHei", sans-serif; user-select: none; }
        #game-container { position: relative; width: 100vw; height: 100vh; background: #4caf50; display: none; }
        
        /* 選單 */
        #menu { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            background: white; padding: 30px; border-radius: 20px; text-align: center; z-index: 1000; width: 85%;
        }
        .options-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 20px; }
        .char-option { padding: 10px; border: 2px solid #ddd; border-radius: 10px; cursor: pointer; background: #f9f9f9; }
        .char-option:hover { border-color: #2e7d32; background: #e8f5e9; }
        .char-option img { width: 100%; height: 100px; object-fit: contain; background: #eee; }

        /* 遊戲元素 */
        #player { position: absolute; left: 50px; width: 80px; height: 80px; z-index: 100; }
        #player img { width: 100%; height: 100%; object-fit: contain; }
        .bullet { position: absolute; width: 30px; height: 30px; z-index: 90; }
        .bullet img { width: 100%; height: 100%; object-fit: contain; }
        .enemy { position: absolute; width: 70px; height: 70px; z-index: 80; }
        .enemy img { width: 100%; height: 100%; object-fit: contain; }

        /* HUD */
        #hud { position: absolute; top: 10px; right: 10px; color: white; background: rgba(0,0,0,0.6); padding: 10px; border-radius: 8px; z-index: 500; }
        #result-screen { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; text-align: center; z-index: 2000; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

    <div id="menu">
        <h2>請選擇組別開始遊戲</h2>
        <div class="options-grid">
            <div class="char-option" onclick="startGame('豌豆射手.webp', '豌豆1-2.png', '孟德爾1-1.jpg')">
                <img src="豌豆射手.webp" onerror="this.src='https://via.placeholder.com/100?text=P1'">
                <p>1. 孟德爾組</p>
            </div>
            <div class="char-option" onclick="startGame('豌豆射手.webp', '榴槤2-2.jpg', '牛頓2-1.jpg')">
                <img src="豌豆射手.webp" onerror="this.src='https://via.placeholder.com/100?text=P2'">
                <p>2. 牛頓組</p>
            </div>
            <div class="char-option" onclick="startGame('豌豆射手.webp', '原子3-2.png', '道爾頓3-1.jpg')">
                <img src="豌豆射手.webp" onerror="this.src='https://via.placeholder.com/100?text=P3'">
                <p>3. 道爾頓組</p>
            </div>
            <div class="char-option" onclick="startGame('豌豆射手.webp', '肥皂4-2.jpg', '王安石4-1.jpg')">
                <img src="豌豆射手.webp" onerror="this.src='https://via.placeholder.com/100?text=P4'">
                <p>4. 王安石組</p>
            </div>
        </div>
    </div>

    <div id="game-container">
        <div id="hud">
            <div>得分: <span id="score">0</span> | 時間: <span id="timer">60</span>s</div>
            <button onclick="togglePause()" id="pBtn">暫停</button>
            <button onclick="location.reload()">重新選擇</button>
        </div>
        <div id="player"></div>
    </div>

    <div id="result-screen">
        <h2>遊戲結束</h2>
        <p>得分：<span id="final-score">0</span></p>
        <button onclick="location.reload()">返回選單</button>
    </div>

    <script>
        let score = 0, timeLeft = 60, gameActive = false, isPaused = false;
        let enemies = [], bullets = [], currentB, currentE;
        let spawnInterval, timerInterval;

        const player = document.getElementById('player');
        const gameContainer = document.getElementById('game-container');
        const scoreEl = document.getElementById('score');
        const timerEl = document.getElementById('timer');

        function startGame(p, b, e) {
            currentB = b; currentE = e;
            document.getElementById('menu').style.display = 'none';
            gameContainer.style.display = 'block';
            
            // 設定玩家圖片
            player.innerHTML = `<img src="${p}" onerror="this.parentElement.style.background='blue'">`;
            
            gameActive = true;
            score = 0; timeLeft = 60;
            
            // 啟動循環
            spawnInterval = setInterval(spawnEnemy, 1800);
            timerInterval = setInterval(tick, 1000);
            requestAnimationFrame(update);
        }

        function spawnEnemy() {
            if (!gameActive || isPaused) return;
            const el = document.createElement('div');
            el.className = 'enemy';
            el.innerHTML = `<img src="${currentE}" onerror="this.parentElement.style.background='red'">`;
            let y = Math.random() * (window.innerHeight - 100);
            el.style.top = y + 'px';
            el.style.left = window.innerWidth + 'px';
            gameContainer.appendChild(el);
            enemies.push({ el: el, x: window.innerWidth, y: y });
        }

        function fire() {
            if (!gameActive || isPaused) return;
            const el = document.createElement('div');
            el.className = 'bullet';
            el.innerHTML = `<img src="${currentB}" onerror="this.parentElement.style.background='yellow'">`;
            let y = player.offsetTop + 25;
            let x = 110;
            el.style.top = y + 'px';
            el.style.left = x + 'px';
            gameContainer.appendChild(el);
            bullets.push({ el: el, x: x, y: y });
        }

        window.addEventListener('mousemove', (e) => {
            if (!gameActive || isPaused) return;
            let y = e.clientY - 40;
            if (y < 0) y = 0;
            if (y > window.innerHeight - 80) y = window.innerHeight - 80;
            player.style.top = y + 'px';
        });

        window.addEventListener('mousedown', (e) => { if(e.button === 0) fire(); });

        function update() {
            if (!gameActive || isPaused) {
                if(gameActive) requestAnimationFrame(update);
                return;
            }

            // 子彈移動
            for (let i = bullets.length - 1; i >= 0; i--) {
                bullets[i].x += 7;
                bullets[i].el.style.left = bullets[i].x + 'px';
                if (bullets[i].x > window.innerWidth) {
                    bullets[i].el.remove(); bullets.splice(i, 1);
                }
            }

            // 敵人移動
            for (let i = enemies.length - 1; i >= 0; i--) {
                enemies[i].x -= 2.5; // 固定慢速
                enemies[i].el.style.left = enemies[i].x + 'px';

                // 碰撞檢測
                for (let j = bullets.length - 1; j >= 0; j--) {
                    if (Math.abs(bullets[j].x - enemies[i].x) < 40 && Math.abs(bullets[j].y - enemies[i].y) < 40) {
                        score++; scoreEl.innerText = score;
                        enemies[i].el.remove(); enemies.splice(i, 1);
                        bullets[j].el.remove(); bullets.splice(j, 1);
                        break;
                    }
                }

                // 漏掉敵人
                if (enemies[i] && enemies[i].x < 0) {
                    score = Math.max(0, score - 1);
                    scoreEl.innerText = score;
                    enemies[i].el.remove(); enemies.splice(i, 1);
                }
            }
            requestAnimationFrame(update);
        }

        function tick() {
            if (!gameActive || isPaused) return;
            timeLeft--;
            timerEl.innerText = timeLeft;
            if (timeLeft <= 0) {
                gameActive = false;
                document.getElementById('result-screen').style.display = 'block';
                document.getElementById('final-score').innerText = score;
            }
        }

        function togglePause() {
            isPaused = !isPaused;
            document.getElementById('pBtn').innerText = isPaused ? "繼續" : "暫停";
        }
    </script>
</body>
</html>