<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>閃電尾巴巴弟：真實紋理偵察任務</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Noto+Sans+TC:wght@400;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --comic-yellow: #ffde00;
            --comic-red: #ff4d4d;
            --comic-blue: #2e5bff;
        }
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: #f0f0f0;
            background-image: radial-gradient(rgba(0,0,0,0.1) 1px, transparent 0);
            background-size: 25px 25px;
        }
        .comic-font { font-family: 'Bangers', 'Noto Sans TC', cursive; }
        
        .comic-btn {
            background: var(--comic-yellow);
            border: 4px solid #000;
            box-shadow: 6px 6px 0px #000;
            transition: 0.1s;
        }
        .comic-btn:hover { transform: translate(-2px, -2px); box-shadow: 8px 8px 0px #000; }

        #story-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 50;
        }

        #audio-toggle {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 50;
        }

        #story-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.98);
            z-index: 100;
            overflow-y: auto;
            background-image: radial-gradient(rgba(0,0,0,0.05) 1px, transparent 0);
            background-size: 10px 10px;
        }
        .book-page {
            max-width: 850px;
            margin: 40px auto;
            background: #fff;
            border: 6px solid #000;
            padding: 40px;
            position: relative;
            box-shadow: 15px 15px 0px rgba(0,0,0,0.2);
        }

        .game-panel {
            background: #fff;
            border: 6px solid #000;
            box-shadow: 12px 12px 0px #000;
            position: relative;
        }
        
        .fur-zoom-container {
            width: 100%;
            height: 320px;
            border: 6px solid #000;
            overflow: hidden;
            position: relative;
            background: #222;
        }
        .fur-zoom-image {
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            transition: transform 0.3s ease;
        }
        .fur-zoom-image:hover {
            transform: scale(1.1);
        }
        
        .zoom-label {
            position: absolute;
            top: 10px;
            left: 10px;
            background: var(--comic-red);
            color: white;
            font-family: 'Bangers';
            padding: 5px 15px;
            border: 3px solid #000;
            transform: rotate(-5deg);
            z-index: 10;
        }

        #ai-hint-box {
            display: none;
            background: #eef7ff;
            border: 4px solid #000;
            padding: 15px;
            margin-bottom: 20px;
        }

        .option-btn {
            background: #fff;
            border: 4px solid #000;
            padding: 15px;
            font-size: 1.25rem;
            font-weight: 900;
            transition: 0.1s;
        }
        .option-btn:hover {
            background: var(--comic-yellow);
            transform: translate(-3px, -3px);
            box-shadow: 4px 4px 0px #000;
        }
        
        .loading-dots:after {
            content: '.';
            animation: dots 1.5s steps(5, end) infinite;
        }
        @keyframes dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60% { content: '...'; } 80%, 100% { content: ''; } }

        .story-section {
            border-left: 10px solid var(--comic-yellow);
            padding-left: 20px;
            margin-bottom: 30px;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- 故事書快捷鈕 -->
    <div id="story-btn" class="comic-btn px-4 py-2 cursor-pointer flex items-center" onclick="toggleBook(true)">
        <i class="fas fa-book-open text-2xl mr-2"></i>
        <span class="comic-font text-xl">HERO LOG</span>
    </div>

    <!-- 音效開關鈕 -->
    <div id="audio-toggle" class="comic-btn px-4 py-2 cursor-pointer flex items-center" onclick="toggleAudio()">
        <i id="audio-icon" class="fas fa-volume-up text-2xl mr-2"></i>
        <span class="comic-font text-xl">SFX: ON</span>
    </div>

    <!-- 故事書內頁 -->
    <div id="story-overlay">
        <div class="book-page">
            <div class="absolute top-4 right-4 text-3xl cursor-pointer font-black" onclick="toggleBook(false)">[ CLOSE ]</div>
            <h1 class="comic-font text-6xl text-center mb-10 border-b-8 border-black pb-4">英雄檔案：絕密資料庫</h1>
            
            <div class="space-y-12">
                <!-- 第一章 -->
                <section class="story-section">
                    <h2 class="comic-font text-4xl text-blue-600 underline italic">第一章：金色火花 (巴弟)</h2>
                    <p class="text-xl font-bold mt-4">巴弟的金毛具備儲能效果。當偵察機掃描到這種如麥田般的金色紋理時，代表正義就在附近！</p>
                    <img src="https://images.unsplash.com/photo-1552053831-71594a27632d?auto=format&fit=crop&w=800&q=80" class="w-full h-64 object-cover border-4 border-black mt-4">
                </section>

                <!-- 第二章 -->
                <section class="story-section">
                    <h2 class="comic-font text-4xl text-orange-600 underline italic">第二章：暗影條紋 (老虎)</h2>
                    <div class="mt-4 space-y-4">
                        <p class="text-xl font-bold text-red-600 underline">⚠️ 凱撒教授的噩夢：物理級迷彩</p>
                        <p class="text-lg">這是凱撒教授也無法用演算法徹底破解的<b>「天然混淆陣」</b>。老虎身上的深色條紋在雜草叢中會產生強烈的視覺切割效應。</p>
                        <img src="https://images.unsplash.com/photo-1501705388883-4ed8a543392c?auto=format&fit=crop&w=800&q=80" class="w-full h-64 object-cover border-4 border-black mt-4">
                    </div>
                </section>

                <!-- 第三章 -->
                <section class="story-section">
                    <h2 class="comic-font text-4xl text-gray-600 underline italic">第三章：雲朵防壁 (綿羊)</h2>
                    <div class="mt-4 space-y-4">
                        <p class="text-xl font-bold">綿羊的捲毛是天然的能量緩衝器。當凱撒教授的機械爪試圖抓取時，這些蓬鬆的蛋白質纖維會吸收 90% 的衝擊力。</p>
                        <img src="https://images.unsplash.com/photo-1484557985045-edf25e08da73?auto=format&fit=crop&w=800&q=80" class="w-full h-64 object-cover border-4 border-black mt-4">
                    </div>
                </section>

                <!-- 第四章 -->
                <section class="story-section">
                    <h2 class="comic-font text-4xl text-green-700 underline italic">第四章：生物裝甲 (刺蝟)</h2>
                    <div class="mt-4 space-y-4">
                        <p class="text-xl font-bold text-red-600 underline">⚠️ 注意：偵測到尖銳防禦體</p>
                        <p class="text-lg">這不是普通的毛，是高度角質化的<b>「生物針刺」</b>。每根刺都能單獨調整角度，形成 360 度無死角的防禦圈。</p>
                        <img src="https://images.unsplash.com/photo-1543332145-6e8469950669?auto=format&fit=crop&w=800&q=80" class="w-full h-64 object-cover border-4 border-black mt-4">
                    </div>
                </section>
            </div>
        </div>
    </div>

    <!-- 遊戲主體 -->
    <div class="max-w-2xl mx-auto mt-12">
        <header class="text-center mb-8">
            <h1 class="comic-font text-7xl md:text-8xl italic text-black leading-none uppercase">PET HERO<br><span class="text-red-600">SCANNER</span></h1>
            <div class="flex justify-between mt-6 bg-black text-white p-3 comic-font text-2xl border-4 border-white shadow-xl">
                <span>XP: <span id="score">0</span></span>
                <span>MISSION: <span id="level">1</span>/5</span>
            </div>
        </header>

        <main id="game-container" class="game-panel p-6">
            <div id="quiz-ui">
                <div class="fur-zoom-container mb-6">
                    <div class="zoom-label">LIVE SCAN: ULTRA-ZOOM</div>
                    <div id="fur-target" class="fur-zoom-image"></div>
                </div>

                <button onclick="askMentor()" id="ai-btn" class="w-full bg-blue-600 text-white py-4 comic-font text-2xl mb-4 border-4 border-black hover:bg-black transition flex items-center justify-center gap-3">
                    <i class="fas fa-microscope"></i> 啟動分析 (AI HINT)
                </button>

                <div id="ai-hint-box">
                    <div id="ai-loading" class="hidden font-bold text-center">正在提取紋理特徵<span class="loading-dots"></span></div>
                    <div id="ai-text" class="text-lg leading-snug italic text-center"></div>
                </div>

                <div id="options-grid" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
            </div>

            <!-- 結算畫面 -->
            <div id="end-ui" class="hidden py-8 text-center">
                <h2 class="comic-font text-7xl text-red-600 mb-6 italic">FINAL REPORT</h2>
                <div id="ai-final-report" class="bg-white border-4 border-black p-6 text-left italic font-bold mb-8 text-xl"></div>
                <button onclick="restart()" class="w-full bg-black text-white comic-font text-4xl py-6 border-4 border-black hover:bg-blue-600 transition">REBOOT SYSTEM</button>
            </div>
        </main>

        <!-- 回饋彈窗 -->
        <div id="fb-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/90">
            <div class="bg-white border-8 border-black p-10 max-w-sm w-full text-center transform -rotate-1">
                <div id="fb-icon" class="text-9xl mb-4"></div>
                <div id="fb-text" class="comic-font text-4xl mb-2 uppercase"></div>
                <div id="fb-subtext" class="text-lg font-bold mb-8 text-gray-600"></div>
                <button onclick="next()" class="w-full bg-yellow-400 border-4 border-black py-4 comic-font text-3xl hover:bg-red-500">CONFIRM</button>
            </div>
        </div>
    </div>

    <script>
        const apiKey = ""; 
        const modelName = "gemini-2.5-flash-preview-09-2025";

        // 音效引擎：利用 Web Audio API 生成音效
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let audioEnabled = true;

        function playSound(type) {
            if (!audioEnabled) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            
            const now = audioCtx.currentTime;

            if (type === 'success') {
                // 亮亮的嗶嗶聲
                osc.type = 'sine';
                osc.frequency.setValueAtTime(500, now);
                osc.frequency.exponentialRampToValueAtTime(1200, now + 0.1);
                gain.gain.setValueAtTime(0.3, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                osc.start(now);
                osc.stop(now + 0.3);
            } else if (type === 'fail') {
                // 沉悶的警告聲
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, now);
                osc.frequency.linearRampToValueAtTime(50, now + 0.2);
                gain.gain.setValueAtTime(0.2, now);
                gain.gain.linearRampToValueAtTime(0.01, now + 0.2);
                osc.start(now);
                osc.stop(now + 0.2);
            } else if (type === 'click') {
                // 短促的點擊音
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(400, now);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0.01, now + 0.05);
                osc.start(now);
                osc.stop(now + 0.05);
            } else if (type === 'scan') {
                // 掃描雷達聲
                osc.type = 'square';
                osc.frequency.setValueAtTime(800, now);
                osc.frequency.exponentialRampToValueAtTime(200, now + 0.5);
                gain.gain.setValueAtTime(0.05, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
                osc.start(now);
                osc.stop(now + 0.5);
            }
        }

        function toggleAudio() {
            audioEnabled = !audioEnabled;
            const icon = document.getElementById('audio-icon');
            const span = document.querySelector('#audio-toggle span');
            if (audioEnabled) {
                icon.className = "fas fa-volume-up text-2xl mr-2";
                span.innerText = "SFX: ON";
                if (audioCtx.state === 'suspended') audioCtx.resume();
                playSound('click');
            } else {
                icon.className = "fas fa-volume-mute text-2xl mr-2";
                span.innerText = "SFX: OFF";
            }
        }

        const stages = [
            { 
                name: "金毛尋回犬", 
                options: ["金毛尋回犬", "獅子", "柴犬", "駱駝"], 
                correct: 0, 
                imgUrl: "https://images.unsplash.com/photo-1552053831-71594a27632d?auto=format&fit=crop&w=1000&q=80",
                aiHint: "光譜顯示為高飽和的金色。這是一種非常友善且密集的毛髮結構，偵測到正義感。"
            },
            { 
                name: "老虎", 
                options: ["斑馬", "老虎", "乳牛", "大黃蜂"], 
                correct: 1, 
                imgUrl: "https://images.unsplash.com/photo-1501705388883-4ed8a543392c?auto=format&fit=crop&w=1000&q=80",
                aiHint: "強烈的黑色縱向條紋，背景是橘黃色。這種紋理在自然界中代表著頂級掠食者的偽裝，凱撒教授的演算法最怕這個。"
            },
            { 
                name: "波斯貓", 
                options: ["波斯貓", "綿羊", "白兔", "北極熊"], 
                correct: 0, 
                imgUrl: "https://images.unsplash.com/photo-1526336024174-e58f5cdd8e13?auto=format&fit=crop&w=1000&q=80",
                aiHint: "警報！偵測到極度柔順的長毛結構。這種毛髮通常伴隨著高智商的腦波活動，極有可能是凱撒教授的同類！"
            },
            { 
                name: "綿羊", 
                options: ["雲朵", "綿羊", "比熊犬", "草泥馬"], 
                correct: 1, 
                imgUrl: "https://images.unsplash.com/photo-1484557985045-edf25e08da73?auto=format&fit=crop&w=1000&q=80",
                aiHint: "掃描到捲曲的蛋白質纖維，熱能阻隔率極高。這是絕佳的物理防禦，也是英雄防護服的原材料。"
            },
            { 
                name: "刺蝟", 
                options: ["豪豬", "刺蝟", "仙人掌", "刷子"], 
                correct: 1, 
                imgUrl: "https://images.unsplash.com/photo-1543332145-6e8469950669?auto=format&fit=crop&w=1000&q=80",
                aiHint: "警告：偵測到角質尖刺。這不是普通的毛，是全自動生物防禦系統，建議遠程偵察。"
            }
        ];

        let cur = 0;
        let score = 0;

        async function callGemini(prompt, sys) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;
            const body = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: sys }] }
            };
            try {
                const res = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body)});
                const d = await res.json();
                return d.candidates?.[0]?.content?.parts?.[0]?.text || "偵察系統暫時離線...";
            } catch (e) { return "通訊中斷！"; }
        }

        async function askMentor() {
            playSound('scan');
            const box = document.getElementById('ai-hint-box');
            const txt = document.getElementById('ai-text');
            const load = document.getElementById('ai-loading');
            box.style.display = 'block';
            load.classList.remove('hidden');
            txt.innerText = "";
            
            const res = await callGemini(stages[cur].aiHint, "你是一位專業的寵物英雄偵察員。請用簡短、熱血且帶有科技感的語氣描述這個毛髮特徵。");
            load.classList.add('hidden');
            txt.innerText = res;
        }

        function loadStage() {
            const s = stages[cur];
            document.getElementById('level').innerText = cur + 1;
            const target = document.getElementById('fur-target');
            
            target.style.backgroundImage = `url('${s.imgUrl}')`;
            
            const imgChecker = new Image();
            imgChecker.src = s.imgUrl;
            imgChecker.onerror = () => {
                target.style.background = "#ff4d4d";
                target.innerHTML = "<div class='flex items-center justify-center h-full text-white font-black'>凱撒教授干擾中：圖像毀損</div>";
            };

            document.getElementById('ai-hint-box').style.display = 'none';
            const grid = document.getElementById('options-grid');
            grid.innerHTML = '';
            s.options.forEach((opt, i) => {
                const b = document.createElement('button');
                b.className = "option-btn";
                b.innerText = opt;
                b.onclick = () => {
                    playSound('click');
                    check(i);
                };
                grid.appendChild(b);
            });
        }

        function check(i) {
            const s = stages[cur];
            const modal = document.getElementById('fb-modal');
            const icon = document.getElementById('fb-icon');
            const text = document.getElementById('fb-text');
            const subtext = document.getElementById('fb-subtext');
            
            const isImageError = document.getElementById('fur-target').innerText.includes("凱撒");

            if (i === s.correct) {
                playSound('success');
                score += 20;
                document.getElementById('score').innerText = score;
                icon.innerText = "⚡";
                text.innerText = "匹配成功！";
                subtext.innerText = isImageError ? "偵測到會變形的偽裝動物，已破除幻象！" : `確認目標：${s.name}`;
            } else {
                playSound('fail');
                icon.innerText = "⚠️";
                text.innerText = "辨識失敗！";
                subtext.innerText = "偵測器受到干擾，請重新校準掃描儀。";
            }
            modal.classList.remove('hidden');
        }

        function next() {
            playSound('click');
            cur++;
            document.getElementById('fb-modal').classList.add('hidden');
            document.getElementById('fur-target').innerHTML = ""; 
            if (cur < stages.length) loadStage();
            else finish();
        }

        async function finish() {
            document.getElementById('quiz-ui').classList.add('hidden');
            document.getElementById('end-ui').classList.remove('hidden');
            const report = document.getElementById('ai-final-report');
            report.innerHTML = "正在上傳任務總結<span class='loading-dots'></span>";
            const res = await callGemini(`得分：${score}/100`, "根據玩家得分，撰寫一段短小精悍的英雄戰報。");
            report.innerText = res;
        }

        function restart() {
            playSound('click');
            cur = 0; score = 0;
            document.getElementById('score').innerText = 0;
            document.getElementById('quiz-ui').classList.remove('hidden');
            document.getElementById('end-ui').classList.add('hidden');
            loadStage();
        }

        function toggleBook(show) { 
            playSound('click');
            document.getElementById('story-overlay').style.display = show ? 'block' : 'none'; 
        }

        window.onload = loadStage;
    </script>
</body>
</html>