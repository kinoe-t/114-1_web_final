<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº”å­æ£‹ç‹ï¼šçµ‚æ¥µå›‚å¼µç‰ˆ</title>
    <style>
        :root { --bg: #fdf6e3; --primary: #073642; --board: #dcb35c; --gold: #b58900; --pink: #d33682; }
        body { display: flex; flex-direction: column; align-items: center; background: var(--bg); font-family: "Microsoft JhengHei", sans-serif; margin: 0; padding: 20px; overflow-x: hidden; }
        
        #menu, #bet-menu { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; width: 350px; }
        .wallet-container { background: #f0f9ff; border: 2px solid #268bd2; border-radius: 10px; padding: 10px; margin-bottom: 20px; transition: all 0.3s; }
        .wallet-container.update { animation: shake 0.4s ease-in-out; background: #e0f2fe; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .wallet { color: #268bd2; font-size: 1.8rem; font-weight: bold; }
        
        .btn { display: block; width: 100%; padding: 12px; margin: 10px 0; border: none; border-radius: 8px; cursor: pointer; color: white; font-size: 1rem; transition: 0.2s; }
        .btn-ez { background: #859900; } /* æ”¾æ°´æ¨¡å¼ */
        .btn-mid { background: #b58900; } /* å¾®æ”¾æ°´ */
        .btn-hard { background: #cb4b16; } /* ä¸æ”¾æ°´ */
        .btn-kj { background: #dc322f; font-weight: bold; } /* æŸ¯æ½” */
        .btn-pvp { background: #2aa198; } /* é›™äºº */
        .btn-gamble { background: #6c71c4; } /* è³­å ´ */
        .btn-skip { background: #268bd2; font-weight: bold; display: none; margin-top: 10px; }

        #game-container { display: none; text-align: center; }
        canvas { background: var(--board); box-shadow: 0 10px 40px rgba(0,0,0,0.4); border-radius: 4px; cursor: crosshair; }
        #status { font-size: 1.1rem; font-style: italic; margin: 15px; height: 50px; color: #586e75; line-height: 1.4; }

        .insect-btn { position: fixed; bottom: 30px; font-size: 50px; background: none; border: none; cursor: pointer; z-index: 100; transition: transform 0.2s; }
        .insect-btn:hover { transform: scale(1.1); }
        #btn-bee { left: 30px; }
        #btn-butterfly { right: 30px; }

        .butterfly-particle {
            position: fixed; pointer-events: none; z-index: 99; font-size: 30px; will-change: transform, opacity;
            animation: flap 0.2s infinite alternate ease-in-out;
        }
        @keyframes flap { from { transform: scaleX(1); } to { transform: scaleX(0.5); } }
    </style>
</head>
<body>

<div id="menu">
    <h1>äº”å­æ£‹ç‹ï¼šçµ‚æ¥µå›‚å¼µç‰ˆ</h1>
    <div class="wallet-container" id="wallet-box">
        <div style="font-size: 0.8rem; color: #666;">é–£ä¸‹çš„ç•¶å‰è³‡ç”¢</div>
        <div class="wallet">ğŸ’° $<span id="balance">1000</span></div>
    </div>
    
    <button class="btn btn-ez" onclick="start('ai', 1)">æ”¾æ°´æ¨¡å¼ (AIï¼šé€™æ£‹ç›¤è®“æˆ‘éƒ½æ‡¶å¾—æ€è€ƒäº†)</button>
    <button class="btn btn-mid" onclick="start('ai', 2)">å¾®æ”¾æ°´æ¨¡å¼ (AIï¼šçµ¦é»é¢å­ï¼Œåˆ¥è¼¸å¤ªé›£çœ‹)</button>
    <button class="btn btn-hard" onclick="start('ai', 3)">ä¸æ”¾æ°´æ¨¡å¼ (AIï¼šæ˜¯æ™‚å€™å±•ç¾çœŸæ­£çš„æŠ€è¡“äº†)</button>
    <button class="btn btn-kj" onclick="start('ai', 4)">æŸ¯æ½”æ¨¡å¼ (AIï¼šæ„Ÿå—ä¾†è‡ªé™ç¶­æ‰“æ“Šçš„çµ•æœ›)</button>
    <hr>
    <button class="btn btn-pvp" onclick="start('pvp')">é›™äººå°æˆ° (æ­¡è¿èœé›äº’å•„)</button>
    <button class="btn btn-gamble" onclick="openBet()">ğŸ’ åœ°ä¸‹è³­å ´ (AI äº’æ¯†ï¼Œè€ƒé©—é–£ä¸‹çœ¼å…‰)</button>
</div>

<div id="bet-menu" style="display:none;">
    <h2>ğŸ² ç±Œç¢¼ä¸‹æ³¨</h2>
    <p style="font-size:0.8rem; color:#666">AIå°æˆ°æ¨¡å¼ï¼Œå¹³å±€å…¨é¡é€€æ¬¾</p>
    <div style="margin-bottom:15px">ä¸‹æ³¨é‡: <input type="number" id="bet-amt" value="100" min="10" style="width:100px; text-align:center;"></div>
    <button class="btn" style="background:black" onclick="startGamble(1)">æŠ¼ã€é»‘å­ã€‘å‹ (çœ‹å¥½å®ƒèƒ½éšªå‹)</button>
    <button class="btn" style="background:#eee; color:black; border:1px solid #ccc" onclick="startGamble(2)">æŠ¼ã€ç™½å­ã€‘å‹ (æœŸå¾…å®ƒèƒ½é€†è¥²)</button>
    <button class="btn" style="background:#666" onclick="goHome()">å›ä¸»é¸å–® (é€ƒé¿é›–å¯æ¥ä½†æœ‰ç”¨)</button>
</div>

<div id="game-container">
    <div id="status">æ£‹å±€å¦‚äººç”Ÿï¼Œå……æ»¿ä¸ç¢ºå®šæ€§ã€‚</div>
    <canvas id="board" width="600" height="600"></canvas>
    <button id="skip-btn" class="btn btn-skip" onclick="skipToResult()">ç›´æ¥é–‹ç‰Œ (SKIP)</button>
    <button class="btn" style="background:#073642; width:auto; padding:10px 40px; margin-top:20px" onclick="goHome()">æ”¾æ£„æ­¤å±€ (è¶æ—©æ­¢æ)</button>
</div>

<button id="btn-bee" class="insect-btn" onclick="spawnInsect('ğŸ', 'left')">ğŸ</button>
<button id="btn-butterfly" class="insect-btn" onclick="spawnInsect('ğŸ¦‹', 'right')">ğŸ¦‹</button>

<script>
    const canvas = document.getElementById('board');
    const ctx = canvas.getContext('2d');
    const statusDiv = document.getElementById('status');
    const balanceSpan = document.getElementById('balance');
    const walletBox = document.getElementById('wallet-box');
    const skipBtn = document.getElementById('skip-btn');
    
    const size = 15, padding = 40, spacing = (600 - padding * 2) / (size - 1);
    let board = [], gameOver = false, mode = 'ai', diff = 1, turn = 1; // diff: 1:easy, 2:mid, 3:hard, 4:kj
    let balance = parseInt(localStorage.getItem('gobangBalance')) || 1000;
    let currentBet = 0, betTarget = 0, fixedResult = 0; // 0: draw, 1: black win, 2: white win
    let lastMove = null, rippleR = 0, rippleO = 0;
    let autoTimer = null;

    const aiRoasts = {
        1: [ // Easy
            "å—¯ï¼Œé€™ä¸€æ­¥... æœ‰è‡ªå·±çš„æƒ³æ³•ï¼Œå€¼å¾—é¼“å‹µã€‚",
            "çœ‹ä¾†é–£ä¸‹å°å‹è² æœ‰è‘—è¶…è„«ä¸–ä¿—çš„æ·¡æ³Šã€‚",
            "é€™æ‰‹æ£‹çš„éˆæ„Ÿï¼Œæ˜¯ä¾†è‡ªæŸç¨®è¡Œç‚ºè—è¡“å—ï¼Ÿ",
            "é€™ç¨®éš¨å¿ƒæ‰€æ¬²çš„ä¸‹æ³•ï¼Œå€’ä¹Ÿåˆ¥å…·ä¸€æ ¼ã€‚",
            "æ£‹ç›¤ä¸Šçš„è©©äººï¼Œå¤§æ¦‚å°±æ˜¯é–£ä¸‹é€™èˆ¬å§ã€‚"
        ],
        2: [ // Mid
            "é€™æ­¥æ£‹çš„æ€è·¯ï¼Œä¼¼ä¹åœ¨æˆ‘çš„é æ–™ä¹‹ä¸­ã€‚",
            "æœ‰äº›æ„æ€ï¼Œä½†é‚„ä¸è¶³ä»¥æ§‹æˆå¨è„…ã€‚",
            "é–£ä¸‹æ˜¯å¦è€ƒæ…®éæ›´æ·±é çš„å¸ƒå±€ï¼Ÿå—¯ï¼Œå¤§æ¦‚æ²’æœ‰ã€‚",
            "é€™ä¸€æ‰‹... çœŸæ˜¯æ•™ç§‘æ›¸èˆ¬çš„å¹³åº¸å•Šã€‚",
            "åˆ¥æ€¥ï¼Œæ…¢æ…¢ä¸‹ï¼Œåæ­£æ™‚é–“å¾ˆå¤šã€‚"
        ],
        3: [ // Hard
            "é€™æ­¥æ£‹ï¼Œè®“æˆ‘é–‹å§‹æ€è€ƒæ‚¨çš„äººç”Ÿäº†ã€‚",
            "æˆ‘ä¸å¾—ä¸æ‰¿èªï¼Œé€™æ‰‹æ£‹... å‹‰å¼·é‚„è¡Œã€‚",
            "çœ‹ä¾†é–£ä¸‹æ˜¯æƒ³æŒ‘æˆ°æˆ‘çš„è€å¿ƒå—ï¼Ÿ",
            "æ¯ä¸€æ¬¡è½å­ï¼Œéƒ½æ„Ÿè¦ºåˆ°æ£‹ç›¤åœ¨å“­æ³£ã€‚",
            "å¯æƒœäº†ï¼Œé€™ä¸€æ­¥é›¢å®Œç¾é‚„å·®äº†åè¬å…«åƒé‡Œã€‚"
        ],
        4: [ // Kejie
            "é€™ä¸€æ­¥... è®“æ£‹ç›¤éƒ½æ„Ÿåˆ°å¯‚å¯äº†ã€‚",
            "é–£ä¸‹çš„è…¦è¿´è·¯ï¼Œæœç„¶æ˜¯å‡¡äººç„¡æ³•ç†è§£çš„å¢ƒç•Œã€‚",
            "æ­å–œé–£ä¸‹ï¼ŒæˆåŠŸé¿é–‹äº†æ‰€æœ‰çš„å‹åˆ©ä¹‹è·¯ã€‚",
            "åœ¨çµ•å°çš„å¯¦åŠ›é¢å‰ï¼Œä»»ä½•æ™æ‰éƒ½æ˜¯å¾’å‹ã€‚",
            "æ‚¨çš„æ¯ä¸€æ­¥ï¼Œéƒ½åœ¨ç‚ºæˆ‘çš„å‹åˆ©é‹ªå¢Šã€‚",
            "é€™å°±æ˜¯ä½ å…¨éƒ¨çš„å¯¦åŠ›å—ï¼ŸçœŸæ˜¯ä»¤äººå¤±æœ›ã€‚"
        ]
    };

    const aiWinRewards = {
        1: 50,  // Easy
        2: 150, // Mid
        3: 300, // Hard
        4: 500  // Kejie
    };

    function updateBalanceDisplay() {
        balanceSpan.innerText = balance;
        localStorage.setItem('gobangBalance', balance); // Save balance
        walletBox.classList.add('update');
        setTimeout(() => walletBox.classList.remove('update'), 400);
    }

    function goHome() {
        clearTimeout(autoTimer);
        document.getElementById('game-container').style.display = 'none';
        document.getElementById('bet-menu').style.display = 'none';
        document.getElementById('menu').style.display = 'block';
    }

    function start(m, d) {
        mode = m; diff = d;
        document.getElementById('menu').style.display = 'none';
        document.getElementById('game-container').style.display = 'block';
        skipBtn.style.display = 'none';
        init();
    }

    function openBet() {
        document.getElementById('menu').style.display = 'none';
        document.getElementById('bet-menu').style.display = 'block';
    }

    function startGamble(target) {
        currentBet = parseInt(document.getElementById('bet-amt').value);
        if(isNaN(currentBet) || currentBet > balance || currentBet <= 0) return alert("é–£ä¸‹çš„ç±Œç¢¼ä¼¼ä¹æœ‰äº›æ‰è¥Ÿè¦‹è‚˜ï¼Œè«‹ç†æ€§ä¸‹æ³¨ã€‚");
        balance -= currentBet; updateBalanceDisplay();
        betTarget = target; mode = 'gamble';
        
        // éš¨æ©Ÿçµæœ (10% å¹³å±€, 45% é»‘å‹, 45% ç™½å‹)
        const r = Math.random();
        fixedResult = r < 0.1 ? 0 : (r < 0.55 ? 1 : 2); // 0:draw, 1:black, 2:white

        document.getElementById('bet-menu').style.display = 'none';
        document.getElementById('game-container').style.display = 'block';
        skipBtn.style.display = 'block';
        init();
        autoTimer = setTimeout(aiAutoPlay, 800); // AI auto play
    }

    function init() {
        board = Array.from({length: size}, () => Array(size).fill(0));
        gameOver = false; turn = 1; lastMove = null;
        statusDiv.innerText = mode === 'pvp' ? "é»‘å­å…ˆè¡Œï¼Œè«‹æŒ‡ç¤ºã€‚" : 
                              (mode === 'gamble' ? "AI ä¹‹é–“å°‡å±•é–‹ä¸€å ´ç²¾å½©çš„å°æ±º..." : "é»‘å­å…ˆè¡Œï¼Œè«‹é–‹å§‹é–£ä¸‹çš„è¡¨æ¼”ã€‚");
        requestAnimationFrame(drawLoop);
    }

    function drawLoop() {
        ctx.clearRect(0,0,600,600);
        ctx.strokeStyle = "#443322"; ctx.lineWidth = 1;
        for(let i=0; i<size; i++) {
            ctx.beginPath(); ctx.moveTo(padding, padding+i*spacing); ctx.lineTo(600-padding, padding+i*spacing); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(padding+i*spacing, padding); ctx.lineTo(padding+i*spacing, 600-padding); ctx.stroke();
        }
        for(let r=0; r<size; r++) for(let c=0; c<size; c++) {
            if(board[r][c]) {
                ctx.beginPath(); ctx.arc(padding+c*spacing, padding+r*spacing, spacing*0.4, 0, Math.PI*2);
                ctx.fillStyle = board[r][c]===1 ? "#111" : "#fff"; ctx.fill();
            }
        }
        // è½å­ç‰¹æ•ˆ
        if(lastMove && rippleO > 0) {
            ctx.beginPath(); ctx.arc(padding+lastMove.c*spacing, padding+lastMove.r*spacing, rippleR, 0, Math.PI*2);
            ctx.strokeStyle = `rgba(255,255,255,${rippleO})`; ctx.lineWidth = 3; ctx.stroke();
            rippleR += 1.5; rippleO -= 0.02; // åŠå¾‘æ“´å¤§ï¼Œé€æ˜åº¦é™ä½
        }
        if(!gameOver) requestAnimationFrame(drawLoop);
    }

    function makeMove(r, c) {
        if(board[r][c] || gameOver) return;
        board[r][c] = turn;
        lastMove = {r, c}; rippleR = spacing*0.4; rippleO = 1; // å•Ÿå‹•ç‰¹æ•ˆ
        
        if(checkWin(r, c, turn)) return endGame(turn);
        if(board.flat().every(x => x !== 0)) return endGame(0); // å¹³å±€

        turn = turn === 1 ? 2 : 1;
        
        if(mode === 'ai') {
            if (turn === 2) { // AIçš„å›åˆ
                statusDiv.innerText = "AI æ­£åœ¨æ€è€ƒ... ä½ é‚„æœ‰å¹¾æ­¥å¥½æ£‹å‘¢ï¼Ÿ";
                setTimeout(aiMove, 1200); // çµ¦AIæ€è€ƒæ™‚é–“
            } else { // ç©å®¶çš„å›åˆï¼Œé¡¯ç¤ºAIçš„å˜´ç ²
                statusDiv.innerText = aiRoasts[diff][Math.floor(Math.random()*aiRoasts[diff].length)];
            }
        } else if (mode === 'gamble' && !gameOver) {
            autoTimer = setTimeout(aiAutoPlay, 600);
        } else if (mode === 'pvp') {
             statusDiv.innerText = turn === 1 ? "é»‘å­è«‹è½å­ã€‚" : "ç™½å­è«‹è½å­ã€‚";
        }
    }

    function skipToResult() {
        clearTimeout(autoTimer);
        endGame(fixedResult); // ç›´æ¥æ­æ›‰çµæœ
    }

    function endGame(winner) {
        if(gameOver) return;
        gameOver = true;
        skipBtn.style.display = 'none';
        let msg = "";

        if(winner === 0) { // å¹³å±€
            msg = "æ£‹é€¢æ•µæ‰‹ï¼Œé€™æ˜¯ä¸€å ´å‹¢å‡åŠ›æ•µçš„å¹³å±€ã€‚";
            if(mode === 'gamble') {
                balance += currentBet; // é€€é‚„è³­é‡‘
                msg += "è³­é‡‘å·²å…¨æ•¸å¥‰é‚„ï¼Œä¸‹æ¬¡è«‹ç¹¼çºŒã€‚";
            }
        } else { // æœ‰å‹è² 
            const winnerColor = winner === 1 ? "é»‘å­" : "ç™½å­";
            if(mode === 'ai') {
                if(winner === 1) { // ç©å®¶è´äº†AI
                    const reward = aiWinRewards[diff];
                    balance += reward;
                    msg = `æ­å–œé–£ä¸‹ï¼ŒæˆåŠŸæ“Šæ•—äº†AIï¼è´å¾—ç±Œç¢¼ $${reward}ï¼`;
                } else { // ç©å®¶è¼¸çµ¦AI
                    msg = `å¾ˆéºæ†¾ï¼Œé–£ä¸‹çš„æŒ‘æˆ°å¤±æ•—äº†ã€‚AIè¡¨ç¤ºé€™åªæ˜¯ç†±èº«ã€‚`;
                }
            } else if(mode === 'gamble') {
                if(winner === betTarget) {
                    balance += currentBet * 2; // è³­é‡‘åŠ å€
                    msg = `ã€${winnerColor}ã€‘ç²å‹ï¼æ­å–œé–£ä¸‹æ…§çœ¼è­˜ç ï¼Œè´å¾—ç±Œç¢¼ $${currentBet * 2}ï¼`;
                } else {
                    msg = `ã€${winnerColor}ã€‘ç²å‹ã€‚å¯æƒœé–£ä¸‹é€™æ¬¡åˆ¤æ–·å¤±èª¤ï¼Œç±Œç¢¼å°±ç”±åœ¨ä¸‹ä»£æ”¶äº†ã€‚`;
                }
            } else if (mode === 'pvp') {
                msg = `æ­å–œã€${winnerColor}ã€‘ç²å‹ï¼æ£‹è—é«˜è¶…ï¼Œä»¤äººä½©æœã€‚`;
            }
        }
        updateBalanceDisplay();
        statusDiv.innerText = msg;
    }

    function aiMove() {
        if(gameOver) return;
        let best = -Infinity, moves = [];
        // AIé›£åº¦èª¿æ•´ï¼Œdiffè¶Šå¤§ï¼ŒAIè¶Šå¼·
        // diffå€¼è¶Šé«˜ï¼Œå°ç©å®¶å¨è„…åº¦(evalPt(r,c,1))çš„æ¬Šé‡è¶Šé«˜ï¼Œå³è¶Šæœƒé˜»æ“‹ç©å®¶
        const playerThreatWeight = [0, 0, 0.4, 1.0, 2.0][diff]; // èª¿æ•´å°æ‰‹å¨è„…çš„è©•ä¼°æ¬Šé‡
        
        for(let r=0; r<size; r++) for(let c=0; c<size; c++) {
            if(board[r][c]===0) {
                // è©•ä¼°è‡ªå·±è½å­å¾Œçš„å¾—åˆ† + è©•ä¼°å°æ‰‹åœ¨è©²ä½ç½®è½å­çš„å¨è„…ï¼ˆä¹˜ä¸Šæ¬Šé‡ï¼‰
                let score = evalPoint(r,c,2) + evalPoint(r,c,1) * playerThreatWeight;
                if(score > best) { best=score; moves=[{r,c}]; } else if(score===best) moves.push({r,c});
            }
        }
        const move = moves[Math.floor(Math.random()*moves.length)];
        makeMove(move.r, move.c);
    }

    function aiAutoPlay() { // ç”¨æ–¼AIäº’æ¯†æ¨¡å¼
        if(gameOver) return;
        let best = -Infinity, moves = [];
        for(let r=0; r<size; r++) for(let c=0; c<size; c++) {
            if(board[r][c]===0) {
                let score = evalPoint(r,c,turn) + evalPoint(r,c,turn===1?2:1)*1.1; // ç•¥å¾®çœ‹é‡é˜²å®ˆ
                // å¦‚æœé è¨­çµæœæ˜¯æŸæ–¹å‹åˆ©ï¼Œå‰‡å°åå‘çµæœçš„å¾—åˆ†é€²è¡Œæ‡²ç½°
                if (fixedResult !== 0 && fixedResult !== turn) {
                    score *= 0.7; // ç¨å¾®é™ä½å‚¾å‘æ–¼ç²å‹çš„AIçš„å¾—åˆ†
                }
                if(score > best) { best=score; moves=[{r,c}]; } else if(score===best) moves.push({r,c});
            }
        }
        const move = moves[Math.floor(Math.random()*moves.length)];
        makeMove(move.r, move.c);
    }

    // è©•ä¼°æŸå€‹é»å°æ–¼æŸå€‹ç©å®¶çš„åˆ†æ•¸
    function evalPoint(r,c,player) {
        let score = 0;
        const directions = [[0,1],[1,0],[1,1],[1,-1]]; // æ°´å¹³, å‚ç›´, å°è§’ç·š
        for(let [dr,dc] of directions) {
            let count = 1; // è©²æ–¹å‘ä¸Šé€£å­æ•¸ (åŒ…å«ç•¶å‰é»)
            let openEnds = 0; // é–‹å£æ•¸é‡

            // å‘ä¸€å€‹æ–¹å‘å»¶ä¼¸
            let block1 = false;
            for(let i=1; i<5; i++) {
                let nr = r + dr*i, nc = c + dc*i;
                if(nr<0||nr>=size||nc<0||nc>=size) { block1 = true; break; } // é‚Šç•Œ
                if(board[nr][nc] === player) count++;
                else if(board[nr][nc] === 0) { openEnds++; break; } // é‡åˆ°ç©ºä½
                else { block1 = true; break; } // é‡åˆ°å°æ–¹æ£‹å­
            }

            // å‘å¦ä¸€å€‹æ–¹å‘å»¶ä¼¸
            let block2 = false;
            for(let i=1; i<5; i++) {
                let nr = r - dr*i, nc = c - dc*i;
                if(nr<0||nr>=size||nc<0||nc>=size) { block2 = true; break; } // é‚Šç•Œ
                if(board[nr][nc] === player) count++;
                else if(board[nr][nc] === 0) { openEnds++; break; } // é‡åˆ°ç©ºä½
                else { block2 = true; break; } // é‡åˆ°å°æ–¹æ£‹å­
            }

            // æ ¹æ“šé€£å­æ•¸å’Œé–‹å£æƒ…æ³çµ¦åˆ†
            if (count >= 5) score += 100000; // è´äº†
            else if (count === 4) {
                if (openEnds === 2) score += 10000; // æ´»å››
                else if (openEnds === 1) score += 1000; // çœ å››
            }
            else if (count === 3) {
                if (openEnds === 2) score += 1000; // æ´»ä¸‰
                else if (openEnds === 1) score += 100; // çœ ä¸‰
            }
            else if (count === 2 && openEnds === 2) score += 50; // æ´»äºŒ
        }
        return score;
    }

    function checkWin(r,c,player) {
        const directions = [[0,1],[1,0],[1,1],[1,-1]];
        for(let [dr,dc] of directions) {
            let count = 1;
            for(let i=1; i<5; i++) {
                let nr = r + dr*i, nc = c + dc*i;
                if(nr>=0&&nr<size&&nc>=0&&nc<size&&board[nr][nc]===player) count++; else break;
            }
            for(let i=1; i<5; i++) {
                let nr = r - dr*i, nc = c - dc*i;
                if(nr>=0&&nr<size&&nc>=0&&nc<size&&board[nr][nc]===player) count++; else break;
            }
            if(count>=5) return true;
        }
        return false;
    }

    canvas.addEventListener('mousedown', e => {
        if(gameOver || mode === 'gamble' || (mode === 'ai' && turn === 2)) return;
        const rect = canvas.getBoundingClientRect();
        const c = Math.round((e.clientX-rect.left-padding)/spacing);
        const r = Math.round((e.clientY-rect.top-padding)/spacing);
        if(r>=0 && r<size && c>=0 && c<size) makeMove(r,c);
    });

    function spawnInsect(emoji, side) {
        for (let i = 0; i < 6; i++) {
            const el = document.createElement('div');
            el.className = 'butterfly-particle';
            el.innerText = emoji;
            document.body.appendChild(el);

            const startX = side === 'left' ? -50 : window.innerWidth + 50;
            const startY = window.innerHeight * (0.3 + Math.random() * 0.4);
            
            let progress = 0;
            const freq = 0.002 + Math.random() * 0.003; // æ³¢æµªé »ç‡
            const amp = 60 + Math.random() * 120; // æ³¢æµªå¹…åº¦
            const speed = 2 + Math.random() * 2; // é£›è¡Œé€Ÿåº¦

            function fly() {
                progress += speed;
                const curX = side === 'left' ? startX + progress : startX - progress;
                const curY = startY + Math.sin(progress * freq) * amp;
                
                el.style.left = curX + 'px';
                el.style.top = curY + 'px';
                el.style.opacity = 1 - (progress / window.innerWidth); // é€æ¼¸æ·¡å‡º

                if (progress < window.innerWidth + 200) { // é£›å‡ºè¢å¹•å¾Œç§»é™¤
                    requestAnimationFrame(fly);
                } else {
                    el.remove();
                }
            }
            fly();
        }
    }

    updateBalanceDisplay(); // Initial display of balance
</script>
</body>
</html>